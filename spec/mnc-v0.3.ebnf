(* MNC v0.3 â€” Compact EBNF
   Notes:
   - This EBNF specifies structural grammar and target token forms.
   - Semantic constraints (deterministic precedence, alias resolution, canonical save) are normative in mnc-v0.3.md.
   - Node bodies are Markdown and are treated as opaque text until the next unescaped BlockHeader.
*)

MNCFile        = { BlankLine } CanvasHeader NL
                 { ( BlankLine | StyleBlock | RuleLine | NodeBlock | LinkLine | NoteLine ) } EOF ;

(* Canvas header must be the first non-empty line. *)
CanvasHeader   = DirCanvasHeader ;
DirCanvasHeader= "=" SP "canvas:" SP Title SP Version ;

Version        = "v" Int "." Int ;

(* -------------------------
   Directives and escaping
   ------------------------- *)

(* A line is considered a directive only if it begins at column 0 and is not escaped.
   Escaped directives are treated as literal text (NoteLine or MarkdownLine).
*)
EscapedLine    = "\\" ( "=" | "-" ) { AnyChar } ;

(* -------------------------
   Unified tag-style blocks
   ------------------------- *)

StyleBlock     = StyleHeader NL { StylePropLine NL } ;
StyleHeader    = "==" SP "style:" SP StyleTarget ;

(* Canonical target is Tag; legacy StyleName target is accepted for deterministic migration. *)
StyleTarget    = Tag | StyleName ;
StyleName      = TrimmedText ;

StylePropLine  = "-" SP Key ":" SP ValueText ;
Key            = KeyChar { KeyChar } ;
KeyChar        = Letter | Digit | "_" | "." | "-" ;
ValueText      = { AnyCharButNL } ;

(* -------------------------
   Legacy rules (migration input only)
   ------------------------- *)

RuleLine       = "- rule:" SP Tag SP "->" SP "style" SP StyleName NL ;
Tag            = "#" TagChar { TagChar } ;
TagChar        = Letter | Digit | "_" | "-" ;

(* -------------------------
   Nodes
   ------------------------- *)

NodeBlock      = NodeHeader NL NodeBody ;
NodeHeader     = "==" SP NodeID ":" SP NodeTitle [ SP "(" PropList ")" ] ;
NodeID         = Letter { Letter | Digit | "_" | "-" } ;  (* semantic: length 2..32, starts with Letter *)
NodeTitle      = TrimmedText ;

PropList       = Prop { SP Prop } ;
Prop           = FlagProp | Key "=" PropValue ;
FlagProp       = Key ;

PropValue      = QuotedString | BareValue ;
BareValue      = BareChar { BareChar } ;
BareChar       = AnyCharButSpaceOrRParen ;

QuotedString   = DQuote { QChar } DQuote ;
QChar          = EscSeq | AnyCharButDQuoteOrNL ;
EscSeq         = "\\" ( "\\" | DQuote ) ;

(* Node body: all lines until the next unescaped BlockHeader (== at column 0) or EOF.
   Inside NodeBody, lines starting with "- rule:" or "- link:" are markdown text, not directives.
*)
NodeBody       = { MarkdownLine NL } ;
MarkdownLine   = EscapedDirectiveLikeLine | NonHeaderLine ;

EscapedDirectiveLikeLine
              = "\\" ( "=" | "-" ) { AnyCharButNL } ;

NonHeaderLine  = ( NotBlockHeaderStart { AnyCharButNL } ) ;
NotBlockHeaderStart
              = ? any char sequence where the line does NOT begin with "==" at column 0 ? ;

(* -------------------------
   Inline mnc link targets (for extraction)
   ------------------------- *)

MncTarget      = MncIdTarget | MncAliasTarget ;
MncIdTarget    = "mnc:" NodeID ;
MncAliasTarget = "mnc:" AliasTitleToken ;
AliasTitleToken= DQuote { AliasChar } DQuote ;
AliasChar      = AliasEsc | AnyCharButDQuoteOrNL ;
AliasEsc       = "\\" DQuote ;

(* Semantic validation:
   - Ambiguous alias title => E_ALIAS_AMBIGUOUS
   - Missing alias title target => E_ALIAS_UNRESOLVED
   - Any malformed mnc:"... target token => E_ALIAS_MALFORMED
*)

(* -------------------------
   Link lines (explicit)
   ------------------------- *)

LinkLine       = "- link:" SP LinkSpec [ SP PropList ] NL ;

LinkSpec       = NodeID SP ( "->" | "-" ) SP NodeID ;

(* -------------------------
   Notes / blank lines
   ------------------------- *)

BlankLine      = { SP } NL ;

NoteLine       = ( EscapedDirectiveLikeLine | NonDirectiveLine ) NL ;

NonDirectiveLine
              = ? a line that does not begin with any of:
                   "=" SP
                   "==" SP
                   "- rule:"
                   "- link:"
                 at column 0, and is not BlankLine ? ;

(* -------------------------
   Lexical helpers
   ------------------------- *)

Title          = TrimmedText ;
TrimmedText    = { AnyCharButNL } ;
Int            = Digit { Digit } ;

NL             = "\n" ;
SP             = " " { " " | "\t" } ;
DQuote         = "\"" ;

AnyChar        = ? any Unicode scalar value ? ;
AnyCharButNL   = ? any Unicode scalar value except "\n" ? ;
AnyCharButDQuoteOrNL
              = ? any Unicode scalar value except "\"" and "\n" ? ;
AnyCharButSpaceOrRParen
              = ? any Unicode scalar value except SP and ")" and "\n" ? ;

Letter         = "A"..."Z" | "a"..."z" ;
Digit          = "0"..."9" ;

EOF            = ? end of file ? ;
